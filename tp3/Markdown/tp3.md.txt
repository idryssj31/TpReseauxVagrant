TP3 idryss judéaux 2ème année
#
nombre de service dispo
````
[vagrant@node1 system]$ systemctl list-unit-files --type=service | tail -l | cut -d "" -f 1
test.service                                  enabled
tuned.service                                 enabled
vboxadd-service.service                       enabled
vboxadd.service                               enabled
vgauthd.service                               enabled
vmtoolsd-init.service                         enabled
vmtoolsd.service                              enabled
wpa_supplicant.service                        disabled

158 unit files listed.
[vagrant@node1 system]$

````
#
nombre de services actifs
````
[vagrant@node1 system]$ systemctl -t service --all | grep running | wc -l
19
[vagrant@node1 system]$
````
##
nombre de service inactif 
````
[vagrant@node1 system]$ systemctl -t service --all | grep -E 'inactive|failed' | wc -l
77
[vagrant@node1 system]$
````
##
nombre de service enabled
````
[vagrant@node1 system]$ systemctl list-unit-files --type=service | grep enabled | wc -l
36
[vagrant@node1 system]$
````
##


# NGINX

 nginx.service 

-   `ExecStart`
Permet d'indiquer la commande à exécuter au lancement du service. Ce paramètre est obligatoire pour tout les types de service.

-   `ExecStartPre`
Commandes qui s'exécuteront avant `ExecStart`.

-   `PIDFile`
 La famille de fonctions pidfile permet aux démons de gérer les fichiers PID. Il utilise flopen pour verrouiller un fichier pid et détecter les démons déjà en cours d'exécution. 
 
-   `Type`
Configure le type de démarrage du processus pour cette unité de service.

-   `ExecReload`
Commandes qui s'exécuteront lorsque cet appareil sera rechargé via `systemctl reload foo.service`

-   `Description`
Description significative de l'unité. En tant qu'exemple, le texte est affiché dans la sortie de la commande `systemctl status`.

-   `After`
Définit l'ordre dans lequel les unités sont lancées. L'unité est lancée uniquement après l'activation des unités spécifiées dans `After`. Contrairement à `Requires`, `After` n'active pas explicitement les unités spécifiées. L'option `Before` offre une fonctionnalité contraire à `After`.


##
server web
````

==== AUTHENTICATION COMPLETE ===
[web@node1 system]$ sudo systemctl start test.service
[web@node1 system]$ sudo systemctl status test.service
● test.service - Start network service
   Loaded: loaded (/etc/systemd/system/test.service; enabled; vendor preset: disabled)
   Active: active (running) since Thu 2020-10-08 17:37:37 UTC; 4s ago
  Process: 6358 ExecStartPre=/bin/sudo /bin/firewall-cmd --reload (code=exited, status=0/SUCCESS)
  Process: 6352 ExecStartPre=/bin/sudo /bin/firewall-cmd --add-port=${PORT}/tcp --permanent (code=exited, status=0/SUCCESS)
 Main PID: 6391 (python3)
   CGroup: /system.slice/test.service
           └─6391 /bin/python3 -m http.server 8080

Oct 08 17:37:35 node1.tp2.b2 systemd[1]: Starting Start network service...
Oct 08 17:37:35 node1.tp2.b2 sudo[6352]:      web : TTY=unknown ; PWD=/ ; USER=root ; COMMAND=/bin/firewall-cmd ...anentOct 08 17:37:36 node1.tp2.b2 sudo[6358]:      web : TTY=unknown ; PWD=/ ; USER=root ; COMMAND=/bin/firewall-cmd --reloadOct 08 17:37:37 node1.tp2.b2 systemd[1]: Started Start network service.
Hint: Some lines were ellipsized, use -l to show in full.
[web@node1 system]$   
````
##
````
[vagrant@node1 system]$ sudo  grep  -ls 'WantedBy=multi-user.target' -r
test.service
[vagrant@node1 system]$
````

## II. Autres features

1. Gestion de boot(sur une centos8)
````
[vagrant@localhost ~]$ systemd-analyze plot > boot.svg
````
````
[vagrant@localhost ~]$ cat boot.svg

<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="4374px" height="2090px" version="1.1" xmlns="http://www.w3.org/2000/svg">

<!-- This file is a systemd-analyze SVG file. It is best rendered in a   -->
<!-- browser such as Chrome, Chromium or Firefox. Other applications     -->
<!-- that render these files properly but much slower are ImageMagick,   -->
<!-- gimp, inkscape, etc. To display the files on your system, just      -->
<!-- point your browser to this file.                                    -->

<!-- This plot was generated by systemd-analyze version 239              -->

<defs>
  <style type="text/css">
    <![CDATA[
      rect       { stroke-width: 1; stroke-opacity: 0; }
      rect.background   { fill: rgb(255,255,255); }
      rect.activating   { fill: rgb(255,0,0); fill-opacity: 0.7; }
      rect.active       { fill: rgb(200,150,150); fill-opacity: 0.7; }
      rect.deactivating { fill: rgb(150,100,100); fill-opacity: 0.7; }
      rect.kernel       { fill: rgb(150,150,150); fill-opacity: 0.7; }
      rect.initrd       { fill: rgb(150,150,150); fill-opacity: 0.7; }
      rect.firmware     { fill: rgb(150,150,150); fill-opacity: 0.7; }
      rect.loader       { fill: rgb(150,150,150); fill-opacity: 0.7; }
      rect.userspace    { fill: rgb(150,150,150); fill-opacity: 0.7; }
      rect.security     { fill: rgb(144,238,144); fill-opacity: 0.7; }
      rect.generators   { fill: rgb(102,204,255); fill-opacity: 0.7; }
      rect.unitsload    { fill: rgb( 82,184,255); fill-opacity: 0.7; }
      rect.box   { fill: rgb(240,240,240); stroke: rgb(192,192,192); }
      line       { stroke: rgb(64,64,64); stroke-width: 1; }
//    line.sec1  { }
      line.sec5  { stroke-width: 2; }
      line.sec01 { stroke: rgb(224,224,224); stroke-width: 1; }
      text       { font-family: Verdana, Helvetica; font-size: 14px; }
      text.left  { font-family: Verdana, Helvetica; font-size: 14px; text-anchor: start; }
      text.right { font-family: Verdana, Helvetica; font-size: 14px; text-anchor: end; }
      text.sec   { font-size: 10px; }
    ]]>
   </style>
</defs>

<rect class="background" width="100%" height="100%" />
<text x="20" y="50">Startup finished in 1.255s (kernel) + 4.885s (initrd) + 36.797s (userspace) = 42.938s
multi-user.target reached after 36.726s in userspace</text><text x="20" y="30">CentOS Linux 8 (Core) localhost.localdomain (Linux 4.18.0-80.el8.x86_64 #1 SMP Tue Jun 4 09:19:46 UTC 2019) x86-64 oracle</text><g transform="translate(20.000,100)">
````
#
````

[vagrant@localhost ~]$ systemd-analyze blam > ok.svg
[vagrant@localhost ~]$ cat ok.svg
         30.415s NetworkManager-wait-online.service
         20.699s dnf-makecache.service
          9.118s tuned.service
          3.433s sssd.service
          2.927s sshd-keygen@rsa.service
          2.318s dracut-initqueue.service
          2.116s initrd-switch-root.service
          2.090s systemd-hwdb-update.service
          2.028s polkit.service
          1.248s NetworkManager.service
          1.065s sshd-keygen@ed25519.service
           897ms chronyd.service
           887ms sshd-keygen@ecdsa.service
           876ms systemd-udev-trigger.service
           783ms systemd-logind.service
           600ms systemd-vconsole-setup.service
           571ms ldconfig.service
           499ms sshd.service
           459ms auditd.service
           404ms import-state.service
           390ms user@1000.service
           389ms var-lib-nfs-rpc_pipefs.mount
           382ms systemd-user-sessions.service
           350ms gssproxy.service
           325ms rpcbind.service
           305ms initrd-parse-etc.service
           302ms systemd-tmpfiles-setup.service
           284ms systemd-sysusers.service
           278ms sysroot.mount
           227ms dracut-pre-pivot.service
           219ms systemd-journald.service
           206ms kdump.service
           202ms sys-kernel-debug.mount
           197ms systemd-tmpfiles-setup-dev.service
           187ms systemd-journal-catalog-update.service
           177ms dracut-cmdline.service
           174ms systemd-udevd.service
           168ms systemd-sysctl.service
           165ms systemd-journal-flush.service
           147ms rsyslog.service
           136ms systemd-tmpfiles-clean.service
           133ms systemd-random-seed.service
           131ms systemd-machine-id-commit.service
           118ms systemd-remount-fs.service
           103ms dev-hugepages.mount
           101ms kmod-static-nodes.service
            98ms swapfile.swap
            91ms systemd-update-done.service
            85ms dev-mqueue.mount
            84ms rpc-statd-notify.service
            80ms dracut-pre-udev.service
            78ms nis-domainname.service
            66ms systemd-update-utmp-runlevel.service
            56ms dracut-shutdown.service
            49ms initrd-cleanup.service
            47ms systemd-update-utmp.service
            26ms sys-kernel-config.mount
            24ms systemd-fsck-root.service
            21ms initrd-udevadm-cleanup-db.service
[vagrant@localhost ~]$
````


## 2. Gestion de l'heure
# A) le fuseau horaire
````
[vagrant@localhost ~]$ timedatectl
               Local time: Fri 2020-10-09 08:20:15 UTC
           Universal time: Fri 2020-10-09 08:20:15 UTC
                 RTC time: Fri 2020-10-09 08:20:17
                Time zone: UTC (UTC, +0000)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
  ````

# B) synchronisation avec server NTP
````
[vagrant@localhost etc]$ sudo dnf install chrony
````

````
[vagrant@localhost etc]$ systemctl enable chronyd
````
````
[vagrant@localhost etc]$ cd /etc/chrony.conf  
````
J'ai changé cette ligne pour y mettre mon ip.
#allow 192.168.56.106/24

````
[vagrant@localhost etc]$  systemctl restart chronyd
==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ====
Authentication is required to restart 'chronyd.service'.
Authenticating as: root
Password:
==== AUTHENTICATION COMPLETE ====
[vagrant@localhost etc]$
````
##
````
[vagrant@localhost etc]$ sudo systemctl start chronyd
[vagrant@localhost etc]$ sudo systemctl status chronyd
● chronyd.service - NTP client/server
   Loaded: loaded (/usr/lib/systemd/system/chronyd.service; enabled; vendor preset: enabled)
   Active: active (running) since Fri 2020-10-09 09:00:55 UTC; 2min 44s ago
     Docs: man:chronyd(8)
           man:chrony.conf(5)
  Process: 22023 ExecStartPost=/usr/libexec/chrony-helper update-daemon (code=exited, status=0/SUCCESS)
  Process: 22018 ExecStart=/usr/sbin/chronyd $OPTIONS (code=exited, status=0/SUCCESS)
 Main PID: 22021 (chronyd)
    Tasks: 1 (limit: 6107)
   Memory: 824.0K
   CGroup: /system.slice/chronyd.service
           └─22021 /usr/sbin/chronyd

Oct 09 09:00:54 localhost.localdomain systemd[1]: Stopped NTP client/server.
Oct 09 09:00:54 localhost.localdomain systemd[1]: Starting NTP client/server...
Oct 09 09:00:54 localhost.localdomain chronyd[22021]: chronyd version 3.5 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDR>
Oct 09 09:00:54 localhost.localdomain chronyd[22021]: Frequency 11.876 +/- 5.034 ppm read from /var/lib/chrony/drift
Oct 09 09:00:54 localhost.localdomain chronyd[22021]: Using right/UTC timezone to obtain leap second data
Oct 09 09:00:55 localhost.localdomain systemd[1]: Started NTP client/server.
Oct 09 09:01:00 localhost.localdomain chronyd[22021]: Selected source 185.103.119.60
Oct 09 09:01:00 localhost.localdomain chronyd[22021]: System clock TAI offset set to 37 seconds
Oct 09 09:01:01 localhost.localdomain chronyd[22021]: Selected source 195.219.205.9
Oct 09 09:02:05 localhost.localdomain chronyd[22021]: Selected source 178.62.250.107
````

##
````
[vagrant@localhost etc]$ sudo chronyc tracking
Reference ID    : B23EFA6B (ams.aput.net)
Stratum         : 3
Ref time (UTC)  : Fri Oct 09 09:04:14 2020
System time     : 0.000065112 seconds slow of NTP time
Last offset     : -0.001605766 seconds
RMS offset      : 0.001708705 seconds
Frequency       : 13.748 ppm fast
Residual freq   : +0.565 ppm
Skew            : 23.584 ppm
Root delay      : 0.031434637 seconds
Root dispersion : 0.040382363 seconds
Update interval : 64.7 seconds
Leap status     : Normal
[vagrant@localhost etc]$
````
#
````
[vagrant@localhost etc]$ sudo chronyc sources

210 Number of sources = 4
MS Name/IP address         Stratum Poll Reach LastRx Last sample
===============================================================================
^* ntp2.as200552.net             2   6   377    45   -923us[ -926us] +/-   28ms
^+ ntp2.wirehive.net             2   6   377    45   -849us[ -849us] +/-   60ms
^+ ams.aput.net                  2   6   377    46    -59us[  +96us] +/-   58ms
^+ 195.219.205.9                 2   6   377    46   -527us[ -530us] +/-   61ms
[vagrant@localhost etc]$ 
````


# C) changement d'horaire
```
[vagrant@localhost /]$ date
Fri Oct  9 09:11:52 UTC 2020

[vagrant@localhost /]$ cd /usr/share/zoneinfo/
[vagrant@localhost zoneinfo]$ tzselect
Please identify a location so that time zone rules can be set correctly.
Please select a continent, ocean, "coord", or "TZ".
 1) Africa
 2) Americas
 3) Antarctica
 4) Asia
 5) Atlantic Ocean
 6) Australia
 7) Europe
 8) Indian Ocean
 9) Pacific Ocean
10) coord - I want to use geographical coordinates.
11) TZ - I want to specify the time zone using the Posix TZ format.
#?
```
````
#? 7
Please select a country whose clocks agree with yours.
 1) Albania               18) Guernsey              35) Poland
 2) Andorra               19) Hungary               36) Portugal
 3) Austria               20) Ireland               37) Romania
 4) Belarus               21) Isle of Man           38) Russia
 5) Belgium               22) Italy                 39) San Marino
 6) Bosnia & Herzegovina  23) Jersey                40) Serbia
 7) Britain (UK)          24) Latvia                41) Slovakia
 8) Bulgaria              25) Liechtenstein         42) Slovenia
 9) Croatia               26) Lithuania             43) Spain
10) Czech Republic        27) Luxembourg            44) Svalbard & Jan Mayen
11) Denmark               28) Malta                 45) Sweden
12) Estonia               29) Moldova               46) Switzerland
13) Finland               30) Monaco                47) Turkey
14) France                31) Montenegro            48) Ukraine
15) Germany               32) Netherlands           49) Vatican City
16) Gibraltar             33) North Macedonia       50) Åland Islands
17) Greece                34) Norway
#?

````

````
#? 14

The following information has been given:

        France

Therefore TZ='Europe/Paris' will be used.
Selected time is now:   Fri Oct  9 11:16:52 CEST 2020.
Universal Time is now:  Fri Oct  9 09:16:52 UTC 2020.
Is the above information OK?
1) Yes
2) No
#? 1

You can make this change permanent for yourself by appending the line
        TZ='Europe/Paris'; export TZ
to the file '.profile' in your home directory; then log out and log in again.

Here is that TZ value again, this time on standard output so that you
can use the /usr/bin/tzselect command in shell scripts:
Europe/Paris
[vagrant@localhost zoneinfo]$
````

# 3. Gestion des noms et de la résolution de noms

````
[vagrant@localhost /]$ hostnamectl status
   Static hostname: localhost.localdomain
         Icon name: computer-vm
           Chassis: vm
        Machine ID: f11a9e0729f5451db98d311386920096
           Boot ID: 7ae8730641204d20846c76408ed7b518
    Virtualization: oracle
  Operating System: CentOS Linux 8 (Core)
       CPE OS Name: cpe:/o:centos:centos:8
            Kernel: Linux 4.18.0-80.el8.x86_64
      Architecture: x86-64
      
 ````
````
[vagrant@localhost /]$ sudo hostnamectl set-hostname Cestvendredi
````

````
[vagrant@localhost /]$ hostnamectl status
   Static hostname: Cestvendredi
         Icon name: computer-vm
           Chassis: vm
        Machine ID: f11a9e0729f5451db98d311386920096
           Boot ID: 7ae8730641204d20846c76408ed7b518
    Virtualization: oracle
  Operating System: CentOS Linux 8 (Core)
       CPE OS Name: cpe:/o:centos:centos:8
            Kernel: Linux 4.18.0-80.el8.x86_64
      Architecture: x86-64
````